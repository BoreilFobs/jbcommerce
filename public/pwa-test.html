<!DOCTYPE html>
<html>
<head>
    <title>PWA Installation Test - JB Shop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="/manifest.json">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #ff7e00; font-size: 24px; }
        .test-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .pass { color: #22c55e; font-weight: bold; }
        .fail { color: #ef4444; font-weight: bold; }
        .warning { color: #f59e0b; font-weight: bold; }
        button {
            background: #ff7e00;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #e06d00; }
        pre {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .btn-row { display: flex; flex-wrap: wrap; gap: 8px; }
    </style>
</head>
<body>
    <h1>üîç JB Shop PWA Test v2.4</h1>
    <p>Testing PWA installation requirements.</p>
    
    <div id="results"></div>
    
    <div class="test-item">
        <h3>üì± Actions</h3>
        <div class="btn-row">
            <button onclick="runTests()">Run Tests</button>
            <button onclick="showModal()">Show Modal</button>
            <button onclick="showButton()">Show Button</button>
            <button onclick="clearAll()">Clear Data</button>
        </div>
    </div>
    
    <div class="test-item">
        <h3>üîß Console</h3>
        <pre id="console">Loading...</pre>
    </div>

    <!-- Load the PWA script -->
    <script src="/js/pwa-init-v2.js?v=2.4.0"></script>
    
    <script>
        let consoleOutput = '';
        
        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            consoleOutput += `[${time}] ${icon} ${msg}\n`;
            document.getElementById('console').textContent = consoleOutput;
            console.log(msg);
        }

        async function runTests() {
            consoleOutput = '';
            const results = document.getElementById('results');
            results.innerHTML = '<h2>Test Results</h2>';
            
            // Test 1: HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            addResult('HTTPS/Localhost', isSecure, isSecure ? 'Secure' : '‚ùå HTTPS required!');
            log(`HTTPS: ${isSecure}`, isSecure ? 'success' : 'error');
            
            // Test 2: Service Worker
            const hasSW = 'serviceWorker' in navigator;
            addResult('Service Worker API', hasSW, hasSW ? 'Supported' : 'Not supported');
            log(`Service Worker API: ${hasSW}`, hasSW ? 'success' : 'error');
            
            // Test 3: SW Registered
            if (hasSW) {
                try {
                    const reg = await navigator.serviceWorker.getRegistration();
                    const registered = !!reg;
                    addResult('SW Registered', registered, registered ? `Scope: ${reg.scope}` : 'Not registered');
                    log(`SW Registered: ${registered}`, registered ? 'success' : 'warning');
                } catch (e) {
                    addResult('SW Registered', false, e.message);
                }
            }
            
            // Test 4: Manifest
            try {
                const res = await fetch('/manifest.json');
                if (res.ok) {
                    const m = await res.json();
                    addResult('Manifest', true, `${m.short_name} - ${m.icons.length} icons`);
                    log(`Manifest: ${m.short_name}`, 'success');
                } else {
                    addResult('Manifest', false, `HTTP ${res.status}`);
                }
            } catch (e) {
                addResult('Manifest', false, e.message);
            }
            
            // Test 5: Icons
            for (const size of ['192x192', '512x512']) {
                try {
                    const r = await fetch(`/icons/icon-${size}.png`);
                    addResult(`Icon ${size}`, r.ok, r.ok ? '‚úì' : `HTTP ${r.status}`);
                } catch (e) {
                    addResult(`Icon ${size}`, false, e.message);
                }
            }
            
            // Test 6: Install prompt
            const hasPrompt = window.PWA && window.PWA.getDeferredPrompt && !!window.PWA.getDeferredPrompt();
            addResult('Install Prompt', hasPrompt, hasPrompt ? 'Available!' : 'Not yet (wait or check HTTPS)');
            log(`Install Prompt: ${hasPrompt}`, hasPrompt ? 'success' : 'warning');
            
            // Test 7: Not installed
            const installed = window.PWA && window.PWA.isInstalled && window.PWA.isInstalled();
            addResult('Not Installed', !installed, installed ? 'Already installed' : 'Can install');
            
            // Test 8: Mobile
            const mobile = window.PWA && window.PWA.isMobile && window.PWA.isMobile();
            addResult('Mobile Device', true, mobile ? 'Yes (modal will show)' : 'No (desktop)');
            
            log('Tests complete!', 'success');
        }
        
        function addResult(name, pass, details) {
            const results = document.getElementById('results');
            results.innerHTML += `
                <div class="test-item">
                    <strong>${name}:</strong> 
                    <span class="${pass ? 'pass' : 'fail'}">${pass ? '‚úÖ PASS' : '‚ùå FAIL'}</span>
                    <br><small>${details}</small>
                </div>
            `;
        }
        
        function showModal() {
            if (window.PWA && window.PWA.showInstallModal) {
                sessionStorage.removeItem('pwa_modal_shown');
                localStorage.removeItem('pwa_modal_dismissed');
                window.PWA.showInstallModal();
                log('Modal triggered', 'success');
            } else {
                log('PWA not loaded yet', 'error');
            }
        }
        
        function showButton() {
            if (window.PWA && window.PWA.showInstallButton) {
                window.PWA.showInstallButton();
                log('Button triggered', 'success');
            } else {
                log('PWA not loaded yet', 'error');
            }
        }
        
        async function clearAll() {
            // Clear SW
            if ('serviceWorker' in navigator) {
                const regs = await navigator.serviceWorker.getRegistrations();
                for (let reg of regs) await reg.unregister();
                log('Service workers cleared', 'success');
            }
            // Clear caches
            if ('caches' in window) {
                const keys = await caches.keys();
                for (let key of keys) await caches.delete(key);
                log('Caches cleared', 'success');
            }
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            log('Storage cleared', 'success');
            
            alert('All PWA data cleared! Page will reload.');
            location.reload(true);
        }
        
        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runTests, 500);
        });
    </script>
</body>
</html>
